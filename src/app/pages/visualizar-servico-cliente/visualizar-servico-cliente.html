<div class="container py-4">
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">Detalhes da Solicitação #{{ solicitacao.id }}</h2>
    <a (click)="voltar()" class="btn btn-outline-secondary"><i class="fa fa-arrow-left me-2"></i> Voltar</a>
  </div>
  
  <div class="row mb-4 g-4">
    
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-bold">Informações do Serviço</div>
        <div class="card-body">
          <p class="mb-2"><strong>Cliente:</strong> <span class="text-muted">{{ solicitacao.clienteNome }}</span></p>
          <hr>
          <p class="mb-2"><strong>Equipamento:</strong> <span class="text-muted">{{ solicitacao.descricaoEquipamento }}</span></p>
          <p class="mb-2"><strong>Categoria:</strong> <span class="text-muted">{{ solicitacao.categoriaEquipamento }}</span></p>
          <p class="mb-2"><strong>Defeito Relatado:</strong> <span class="text-muted">{{ solicitacao.descricaoDefeito }}</span></p>
          <p class="mb-0"><strong>Data da Solicitação:</strong> <span class="text-muted">{{ solicitacao.dataHora | dataptbr }}</span></p>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card shadow-lg h-100 border-{{ solicitacao.estado === 'ORCADA' ? 'warning' : solicitacao.estado === 'ARRUMADA' ? 'success' : 'primary' }}">
        <div class="card-header bg-primary text-white fw-bold">Status e Orçamento</div>
        <div class="card-body d-flex flex-column justify-content-between">
          
          <div>
            <p class="mb-3"><strong>Estado Atual:</strong> 
              <span class="badge" [ngClass]="{
                'bg-warning text-dark': solicitacao.estado === 'ABERTA' || solicitacao.estado === 'ORCADA',
                'bg-danger': solicitacao.estado === 'REJEITADA',
                'bg-success': solicitacao.estado === 'APROVADA' || solicitacao.estado === 'ARRUMADA' || solicitacao.estado === 'PAGA',
                'bg-info': solicitacao.estado === 'REDIRECIONADA',
                'bg-secondary': solicitacao.estado === 'FINALIZADA'
              }">
                {{ solicitacao.estado }}
              </span>
            </p>
            
            <h3 class="fw-bold my-4"> 
              Orçamento: 
              <span [ngClass]="{'text-success': solicitacao.valorOrcado, 'text-muted': !solicitacao.valorOrcado}">
                {{ solicitacao.valorOrcado ? (solicitacao.valorOrcado | currency:'BRL':'symbol':'1.2-2') : 'Aguardando Orçamento' }}
              </span>
            </h3>
          </div>

          <div class="d-grid gap-2 mt-4">

            @if (solicitacao.estado === 'ORCADA') {
              <button (click)="aprovarServico()" class="btn btn-success btn-lg">
                <i class="fa fa-check-circle me-2"></i> Aprovar Serviço (R$ {{ solicitacao.valorOrcado }})
              </button>
              <button (click)="rejeitarServico()" class="btn btn-danger btn-sm">
                <i class="fa fa-times-circle me-2"></i> Rejeitar Serviço
              </button>
            }

            @if (solicitacao.estado === 'REJEITADA') {
              <div class="alert alert-danger text-center" role="alert">
                Serviço rejeitado. Motivo: **{{ solicitacao.motivo || 'Não informado.' }}**
              </div>
              <button (click)="resgatarServico()" class="btn btn-primary btn-lg">
                <i class="fa fa-reply me-2"></i> Resgatar e Aprovar Novamente
              </button>
            }

            @if (solicitacao.estado === 'ARRUMADA') {
              <div class="alert alert-success" role="alert">
                <p class="fw-bold mb-1">Serviço Concluído! Pronto para Pagamento.</p>
                <p class="mb-0 small"><strong>Orientações:</strong> {{ solicitacao.orientacoesCliente }}</p>
              </div>
              
              <p class="mb-2 small">Descrição da Manutenção: {{ solicitacao.descricaoManutencao }}</p>

              <button (click)="pagarServico()" class="btn btn-warning btn-lg text-dark">
                <i class="fa fa-credit-card me-2"></i> Pagar Serviço (R$ {{ solicitacao.valorOrcado }})
              </button>
            }

            @if (solicitacao.estado === 'APROVADA' || solicitacao.estado === 'PAGA' || solicitacao.estado === 'FINALIZADA') {
              <div class="alert alert-info text-center" role="alert">
                Serviço em andamento ou concluído. Nenhuma ação pendente.
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white fw-bold">
          Histórico de Alterações ({{ alteracaoHist.length }})
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
            @for (alt of alteracaoHist; track alt) {
              <li class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1 fw-bold">{{ alt.tipo }}</h6>
                  <small class="text-muted">{{ alt.data | dataptbr }}</small>
                </div>
                
                <p class="mb-1 small">
                  @if( alt.descricao && alt.descricao.trim() !== '') {
                     - Motivo: <span class="fw-semibold">{{ alt.descricao }}</span>
                  }

                  @if(alt.tipo === 'Serviço Orçado' && alt.nomeFuncionario){
                    por funcionário: <span class="text-primary">{{ alt.nomeFuncionario }}</span>
                  }

                  @if(alt.tipo === 'Serviço Redirecionado' && alt.nomeFuncionarioRedirecionado){
                    de funcionário {{alt.nomeFuncionario}} para <span class="text-info">{{ alt.nomeFuncionarioRedirecionado }}</span>
                  }
                </p>
              </li>
            }
            @empty {
              <li class="list-group-item text-center text-muted">Nenhuma alteração registrada.</li>
            }
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>